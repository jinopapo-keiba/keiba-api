<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.RaceRepository">
    <resultMap id="raceMap" type="com.example.demo.entity.Race">
        <id property="id" column="id"/>
        <result property="raceName" column="raceName"/>
        <result property="stadium" column="stadium"/>
        <result property="round" column="round"/>
        <result property="raceType" column="raceType"/>
        <result property="raceLength" column="raceLength"/>
        <result property="clockwise" column="clockwise"/>
        <result property="raceCondition" column="raceCondition"/>
        <result property="raceWeather" column="raceWeather"/>
        <result property="grade" column="grade"/>
        <result property="raceDate" column="raceDate"/>
        <collection property="raceHorses" ofType="com.example.demo.entity.RaceHorse">
            <id column="horseId"/>
            <id column="jockeyId"/>
            <id column="id"/>
            <result property="weight" column="weight"/>
            <result property="old" column="old"/>
            <result property="frameNumber" column="frameNumber"/>
            <association javaType="com.example.demo.entity.Horse" property="horse">
                <id property="id" column="horseId"/>
                <result property="name" column="horseName"/>
                <result property="gender" column="horseGender"/>
            </association>
            <association javaType="com.example.demo.entity.Jockey" property="jockey">
                <id column="horseId"/>
                <id column="jockeyId"/>
                <result property="name" column="jockeyName"/>
            </association>
            <association resultMap="com.example.demo.repository.RaceResultRepository.RaceResultMap" property="raceResult"/>
        </collection>
    </resultMap>

    <sql id="topHorseResultsColumn">
        SELECT
            ${column}
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        WHERE
            raceResult.ranking = 1
        AND
            race.raceLength = ${raceLength}
        AND
            race.raceType = ${raceType}
        AND
            race.stadium = ${stadium}
        <!-- グレードが取れてないレースがあるので一旦コメントあうと
        AND
            race.grade = ${grade}
        -->
    </sql>

    <sql id="targetRaceHorseResultsColumn">
        SELECT
            ${column}
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        WHERE
            race.id = subId
        AND
            ranking > 0
    </sql>

    <insert id="saveRace" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO race (
            stadium,
            round,
            raceName,
            raceType,
            raceLength,
            clockwise,
            raceCondition,
            raceWeather,
            grade,
            raceDate
        ) VALUES (
            #{race.stadium},
            #{race.round},
            #{race.raceName},
            #{race.raceType.value},
            #{race.raceLength},
            #{race.clockwise.value},
            #{race.raceCondition.value},
            #{race.raceWeather.value},
            #{race.grade.value},
            #{race.raceDate}
        )
    </insert>

    <update id="updateRace">
        UPDATE
            race
        SET
            stadium = #{race.stadium},
            round = #{race.round},
            raceName = #{race.raceName},
            raceType = #{race.raceType.value},
            raceLength = #{race.raceLength},
            clockwise = #{race.clockwise.value},
            raceCondition = #{race.raceCondition.value},
            raceWeather = #{race.raceWeather.value},
            grade = #{race.grade.value},
            raceDate = #{race.raceDate}
        WHERE
            id = #{race.id}
    </update>

    <select id="fetchRace" resultMap="raceMap">
        SELECT
            raceName,raceType,raceLength,clockwise,raceCondition,raceWeather,grade,raceDate,race.id as id,round,stadium,
            weight,old,raceHorse.frameNumber as frameNumber,
            jockey.id as jockeyId,jockey.name as jockeyName,
            horse.id as horseId,horse.name as horseName, gender as horseGender,
            raceLength as subRaceLength,stadium as subStadium,raceType as subRaceType,
            raceCondition as subRaceCondition,race.id as subId
        <if test="queryParam.beforeRace == false">
            ,fullTime,ranking,cornerRanking,lastRapTime,
            (
            <include refid="topHorseResultsColumn">
                <property name="column" value="avg(fullTime)"/>
                <property name="raceLength" value="subRaceLength"/>
                <property name="grade" value="grade"/>
                <property name="stadium" value="subStadium"/>
                <property name="raceType" value="subRaceType"/>
            </include>
                AND
                    raceCondition = subRaceCondition
            ) as meanFullTime,
            (
            <include refid="topHorseResultsColumn">
                <property name="column" value="avg(lastRapTime)"/>
                <property name="raceLength" value="subRaceLength"/>
                <property name="grade" value="grade"/>
                <property name="stadium" value="subStadium"/>
                <property name="raceType" value="subRaceType"/>
            </include>
                AND
                    raceCondition = subRaceCondition
            ) as meanLastRapTime,
            (
            <include refid="topHorseResultsColumn">
                <property name="column" value="stddev_pop(fullTime)"/>
                <property name="raceLength" value="subRaceLength"/>
                <property name="grade" value="grade"/>
                <property name="stadium" value="subStadium"/>
                <property name="raceType" value="subRaceType"/>
            </include>
                AND
                    raceCondition = subRaceCondition
            ) as stdDeviFullTime,
            (
            <include refid="topHorseResultsColumn">
                <property name="column" value="stddev_pop(lastRapTime)"/>
                <property name="raceLength" value="subRaceLength"/>
                <property name="grade" value="grade"/>
                <property name="stadium" value="subStadium"/>
                <property name="raceCondition" value="raceCondition"/>
                <property name="raceType" value="subRaceType"/>
            </include>
                AND
                    raceCondition = subRaceCondition
            ) as stdDeviLastRapTime,
            (
            <include refid="targetRaceHorseResultsColumn">
                <property name="column" value="avg(fullTime)"/>
            </include>
            ) as meanTargetRaceFullTime,
            (
            <include refid="targetRaceHorseResultsColumn">
                <property name="column" value="avg(lastRapTime)"/>
            </include>
            ) as meanTargetRaceLastRapTime,
            (
            <include refid="targetRaceHorseResultsColumn">
                <property name="column" value="stddev_pop(fullTime)"/>
            </include>
            ) as stdDeviTargetRaceFullTime,
            (
            <include refid="targetRaceHorseResultsColumn">
                <property name="column" value="stddev_pop(lastRapTime)"/>
            </include>
            ) as stdDeviTargetRaceLastRapTime
        </if>
        FROM
            race
        JOIN
            raceHorse
        ON
            raceHorse.raceId = race.id
        JOIN
            horse
        ON
            horseId = horse.id
        JOIN
            jockey
        ON
            jockeyId = jockey.id
        <if test="queryParam.beforeRace == false">
            JOIN
                raceResult
            ON
                raceResult.raceId = race.id
            AND
                raceHorse.frameNumber = raceResult.frameNumber
        </if>
        <where>
            <if test="queryParam.raceId != null">
                race.id = #{queryParam.raceId}
            </if>
            <if test="queryParam.stadium != null">
                AND stadium = #{queryParam.stadium}
            </if>
            <if test="queryParam.round != null">
                AND round = #{queryParam.round}
            </if>
            <if test="queryParam.raceDate != null">
                AND raceDate = #{queryParam.raceDate}
            </if>
            <if test="queryParam.startRaceDate != null">
                AND raceDate >= #{queryParam.startRaceDate}
            </if>
            <if test="queryParam.horseIds != null">
                AND
                    raceHorse.horseId
                IN
                <foreach item="horseId" collection="queryParam.horseIds" open="(" separator="," close=")">
                    #{horseId}
                </foreach>
            </if>
            <if test="queryParam.raceLength != null">
                AND
                    raceLength = #{queryParam.raceLength}
            </if>
        </where>
        ORDER BY
        race.raceDate DESC,
        race.round ASC,
        raceHorse.frameNumber ASC
    </select>

    <select id="fetchRanRaceLength" resultType="com.example.demo.entity.RaceLength">
        SELECT
            raceLength,count(DISTINCT horse.id) as count
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        JOIN
            horse
        ON
            raceHorse.horseId = horse.id
        WHERE
            race.raceDate &gt; now() - INTERVAL 24 MONTH
        AND
            horse.id
        IN (
            select horse.id from race join raceHorse on race.id = raceHorse.raceId join horse on raceHorse.horseId = horse.id WHERE race.id = #{raceId}
        )
        GROUP BY
            raceLength
        ORDER BY
            raceLength
    </select>
</mapper>
