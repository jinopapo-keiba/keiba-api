<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.RaceResultRepository">
    <resultMap id="BestTimeResultMap" type="com.example.demo.entity.BestRaceTime">
        <id column="id"/>
        <result column="fullTime" property="fullTime"/>
        <result column="lastRapTime" property="lastRapTime"/>
        <result column="stadiumFullTime" property="stadiumFullTime"/>
        <result column="stadiumLastRapTime" property="stadiumLastRapTime"/>
        <result column="fullTimeStadium" property="fullTimeStadium"/>
        <result column="allLastRapTime" property="allLastRapTime"/>
        <result column="allLastRapTimeStadium" property="allLastRapTimeStadium"/>
        <result column="allLastRapTimeLength" property="allLastRapTimeLength"/>
        <association javaType="com.example.demo.entity.Horse" property="horse">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <result property="gender" column="gender"/>
        </association>
    </resultMap>

    <insert id="saveRaceResult">
        INSERT INTO raceResult (
            raceId,
            frameNumber,
            fullTime,
            cornerRanking,
            ranking,
            lastRapTime
        )
        VALUE(
            #{race.id},
            #{raceHorse.frameNumber},
            #{raceResult.fullTime},
            #{raceResult.cornerRanking},
            #{raceResult.ranking},
            #{raceResult.lastRapTime}
        )
        ON DUPLICATE KEY
        UPDATE
            fullTime = #{raceResult.fullTime},
            cornerRanking = #{raceResult.cornerRanking},
            ranking = #{raceResult.ranking},
            lastRapTime = #{raceResult.lastRapTime}
    </insert>

    <sql id="raceJoin">
        SELECT DISTINCT
            ${column}
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        WHERE
            horseId = horse.id
        AND
            race.raceDate &gt; now() - INTERVAL 24 MONTH
    </sql>

    <select id="fetchBestRaceTimes" resultMap="BestTimeResultMap">
        SELECT
            id,
            name,
            gender,
            (
                <include refid="raceJoin">
                    <property name="column" value="min(fullTime)"/>
                </include>
                AND
                    race.raceLength = #{raceLength}
            ) as fullTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="GROUP_CONCAT(stadium)"/>
                </include>
                AND
                    race.raceLength = #{raceLength}
                AND
                    fullTime = (
                        <include refid="raceJoin">
                            <property name="column" value="min(fullTime)"/>
                        </include>
                        AND
                            race.raceLength = #{raceLength}
                    )
                GROUP BY
                    stadium
            ) as fullTimeStadium,
            (
                <include refid="raceJoin">
                    <property name="column" value="min(lastRapTime)"/>
                </include>
                AND
                    race.raceLength = #{raceLength}
            ) as lastRapTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="min(fullTime)"/>
                </include>
                AND
                    race.stadium = #{stadium}
                AND
                    race.raceLength = #{raceLength}
            ) as stadiumFullTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="min(lastRapTime)"/>
                </include>
                AND
                    race.stadium = #{stadium}
                AND
                    race.raceLength = #{raceLength}
            ) as stadiumLastRapTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="min(lastRapTime)"/>
                </include>
            ) as allLastRapTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="stadium"/>
                </include>
                AND
                    lastRapTime =(
                        <include refid="raceJoin">
                            <property name="column" value="min(lastRapTime)"/>
                        </include>
                    )
            ) as allLastRapTimeStadium,
            (
                <include refid="raceJoin">
                    <property name="column" value="raceLength"/>
                </include>
                AND
                    lastRapTime =(
                        <include refid="raceJoin">
                            <property name="column" value="min(lastRapTime)"/>
                        </include>
                    )
            ) as allLastRapTimeLength
        FROM
            horse
        WHERE
            id
        IN
            (
                select horse.id from race join raceHorse on race.id = raceHorse.raceId join horse on raceHorse.horseId = horse.id WHERE race.id = #{raceId}
            )
    </select>
</mapper>
