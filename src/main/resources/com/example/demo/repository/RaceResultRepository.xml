<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.RaceResultRepository">
    <resultMap id="BestTimeResultMap" type="com.example.demo.entity.BestRaceTime">
        <id column="id"/>
        <result column="fullTime" property="fullTime"/>
        <result column="lastRapTime" property="lastRapTime"/>
        <result column="stadiumFullTime" property="stadiumFullTime"/>
        <result column="stadiumLastRapTime" property="stadiumLastRapTime"/>
        <association javaType="com.example.demo.entity.Horse" property="horse">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <result property="gender" column="gender"/>
        </association>
    </resultMap>

    <insert id="saveRaceResult">
        INSERT INTO raceResult (
            raceId,
            frameNumber,
            fullTime,
            cornerRanking,
            ranking,
            lastRapTime
        )
        VALUE(
            #{race.id},
            #{raceHorse.frameNumber},
            #{raceResult.fullTime},
            #{raceResult.cornerRanking},
            #{raceResult.ranking},
            #{raceResult.lastRapTime}
        )
        ON DUPLICATE KEY
        UPDATE
            fullTime = #{raceResult.fullTime},
            cornerRanking = #{raceResult.cornerRanking},
            ranking = #{raceResult.ranking},
            lastRapTime = #{raceResult.lastRapTime}
    </insert>

    <select id="fetchBestRaceTimes" resultMap="BestTimeResultMap">
        SELECT
            id,
            name,
            gender,
            (
                SELECT
                    min(fullTime)
                FROM
                    race
                JOIN
                    raceResult
                ON
                    race.id = raceResult.raceId
                JOIN
                    raceHorse
                ON
                    raceHorse.raceId = raceResult.raceId
                AND
                    raceHorse.frameNumber = raceResult.frameNumber
                WHERE
                    horseId = horse.id
                AND
                    race.raceLength = #{raceLength}
                AND
                    race.raceDate &gt; now() - INTERVAL 24 MONTH
            ) as fullTime,
            (
                SELECT
                    min(lastRapTime)
                FROM
                    race
                JOIN
                    raceResult
                ON
                    race.id = raceResult.raceId
                JOIN
                    raceHorse
                ON
                    raceHorse.raceId = raceResult.raceId
                AND
                    raceHorse.frameNumber = raceResult.frameNumber
                WHERE
                    horseId = horse.id
                AND
                    race.raceLength = #{raceLength}
                AND
                    race.raceDate &gt; now() - INTERVAL 24 MONTH
            ) as lastRapTime,
            (
                SELECT
                    min(fullTime)
                FROM
                    race
                JOIN
                    raceResult
                ON
                    race.id = raceResult.raceId
                JOIN
                    raceHorse
                ON
                    raceHorse.raceId = raceResult.raceId
                AND
                    raceHorse.frameNumber = raceResult.frameNumber
                WHERE
                    horseId = horse.id
                AND
                    race.stadium = #{stadium}
                AND
                    race.raceLength = #{raceLength}
                AND
                    race.raceDate &gt; now() - INTERVAL 24 MONTH
            ) as stadiumFullTime,
            (
                SELECT
                    min(lastRapTime)
                FROM
                    race
                JOIN
                    raceResult
                ON
                    race.id = raceResult.raceId
                JOIN
                    raceHorse
                ON
                    raceHorse.raceId = raceResult.raceId
                AND
                    raceHorse.frameNumber = raceResult.frameNumber
                WHERE
                    horseId = horse.id
                AND
                    race.stadium = #{stadium}
                AND
                    race.raceLength = #{raceLength}
                AND
                    race.raceDate &gt; now() - INTERVAL 24 MONTH
        ) as stadiumLastRapTime
        FROM
            horse
        WHERE
            id
        IN
        <foreach item="horseId" collection="horseIds" open="(" separator="," close=")">
            #{horseId}
        </foreach>
    </select>
</mapper>
