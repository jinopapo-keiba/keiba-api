<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.RaceResultRepository">
    <resultMap id="BestTimeResultMap" type="com.example.demo.entity.BestRaceTime">
        <id column="id"/>
        <result column="summaryFullTime" property="fullTime"/>
        <result column="summaryLastRapTime" property="lastRapTime"/>
        <result column="count" property="count"/>
        <association resultMap="com.example.demo.repository.RaceHorseRepository.raceHorsesResultMap" property="raceHorse"/>
    </resultMap>

    <insert id="saveRaceResult">
        INSERT INTO raceResult (
            raceId,
            frameNumber,
            fullTime,
            cornerRanking,
            ranking,
            lastRapTime
        )
        VALUE(
            #{race.id},
            #{raceHorse.frameNumber},
            #{raceResult.fullTime},
            #{raceResult.cornerRanking},
            #{raceResult.ranking},
            #{raceResult.lastRapTime}
        )
        ON DUPLICATE KEY
        UPDATE
            fullTime = #{raceResult.fullTime},
            cornerRanking = #{raceResult.cornerRanking},
            ranking = #{raceResult.ranking},
            lastRapTime = #{raceResult.lastRapTime}
    </insert>

    <sql id="raceJoin">
        SELECT DISTINCT
            ${column}
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        WHERE
            raceHorse.horseId = horse.id
        AND
            race.raceDate &gt; now() - INTERVAL 24 MONTH
    </sql>

    <select id="fetchBestRaceTimes" resultMap="BestTimeResultMap">
        SELECT
            horse.id as horseId,
            horse.name as horseName,
            horse.gender as horseGender,
            raceHorse.old as old,
            raceHorse.weight as weight,
            raceHorse.frameNumber as frameNumber,
            race.stadium as raceStadium,
            jockey.name as jockeyName,
            (
                <choose>
                    <when test='summaryType == @com.example.demo.valueobject.SummaryType@AVG'>
                        <include refid="raceJoin">
                            <property name="column" value="avg(fullTime)"/>
                        </include>
                    </when>
                    <otherwise>
                        <include refid="raceJoin">
                            <property name="column" value="min(fullTime)"/>
                        </include>
                    </otherwise>
                </choose>
                AND
                    race.raceLength = #{raceLength}
                <if test="stadium != null">
                AND
                    race.stadium = #{stadium}
                </if>
                <if test="stadium == null">
                AND
                    race.stadium = raceStadium
                </if>
            ) as summaryFullTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="count(fullTime)"/>
                </include>
                AND
                    race.raceLength = #{raceLength}
                <if test="stadium != null">
                AND
                    race.stadium = #{stadium}
                </if>
                <if test="stadium == null">
                AND
                    race.stadium = raceStadium
                </if>
            ) as count,
            (
                <choose>
                    <when test='summaryType == @com.example.demo.valueobject.SummaryType@AVG'>
                        <include refid="raceJoin">
                            <property name="column" value="avg(lastRapTime)"/>
                        </include>
                    </when>
                    <otherwise>
                        <include refid="raceJoin">
                            <property name="column" value="min(lastRapTime)"/>
                        </include>
                    </otherwise>
                </choose>
                AND
                    race.raceLength = #{raceLength}
                <if test="stadium != null">
                AND
                    race.stadium = #{stadium}
                </if>
                <if test="stadium == null">
                AND
                    race.stadium = raceStadium
                </if>
            ) as summaryLastRapTime
        FROM
            horse
        JOIN
            raceHorse
        ON
            raceHorse.horseId = horse.id
        JOIN
            jockey
        ON
            raceHorse.jockeyId = jockey.id
        JOIN
            race
        ON
            raceHorse.raceId = race.id
        WHERE
            horse.id
        IN
            (
                select horse.id from race join raceHorse on race.id = raceHorse.raceId join horse on raceHorse.horseId = horse.id WHERE race.id = #{raceId}
            )
        AND
            raceHorse.raceId = #{raceId}
        ORDER BY
            raceHorse.frameNumber
    </select>
</mapper>
