<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.RaceResultRepository">
    <resultMap id="BestTimeResultMap" type="com.example.demo.service.dto.BestRaceTimeDto">
        <id column="id"/>
        <result column="summaryFullTime" property="fullTime"/>
        <result column="summaryLastRapTime" property="lastRapTime"/>
        <result column="count" property="count"/>
        <association resultMap="com.example.demo.repository.RaceHorseRepository.raceHorsesResultMap" property="raceHorse"/>
    </resultMap>

    <resultMap id="RaceResultMap" type="com.example.demo.entity.RaceResult">
        <id column="id"/>
        <id column="frameNumber"/>
        <result property="fullTime" column="fullTime"/>
        <result property="ranking" column="ranking"/>
        <result property="cornerRanking" column="cornerRanking"/>
        <result property="lastRapTime" column="lastRapTime"/>
    </resultMap>

    <resultMap id="HorseResultMap" type="com.example.demo.service.dto.HorseResultDto">
        <id column="race.id"/>
        <result column="meanFullTime" property="meanFullTime"/>
        <result column="meanLastRapTime" property="meanLastRapTime"/>
        <result column="stdevpFullTime" property="stdevpFullTime"/>
        <result column="stdevpLastRapTime" property="stdevpLastRapTime"/>
        <association resultMap="RaceResultMap" property="raceResult"/>
        <association javaType="com.example.demo.entity.Race" property="race">
            <id property="id" column="id"/>
            <result property="raceName" column="raceName"/>
            <result property="stadium" column="stadium"/>
            <result property="round" column="round"/>
            <result property="raceType" column="raceType"/>
            <result property="raceLength" column="raceLength"/>
            <result property="clockwise" column="clockwise"/>
            <result property="raceCondition" column="raceCondition"/>
            <result property="raceWeather" column="raceWeather"/>
            <result property="grade" column="grade"/>
            <result property="raceDate" column="raceDate"/>
        </association>
    </resultMap>

    <insert id="saveRaceResult">
        INSERT INTO raceResult (
            raceId,
            frameNumber,
            fullTime,
            cornerRanking,
            ranking,
            lastRapTime
        )
        VALUE(
            #{race.id},
            #{raceHorse.frameNumber},
            #{raceResult.fullTime},
            #{raceResult.cornerRanking},
            #{raceResult.ranking},
            #{raceResult.lastRapTime}
        )
        ON DUPLICATE KEY
        UPDATE
            fullTime = #{raceResult.fullTime},
            cornerRanking = #{raceResult.cornerRanking},
            ranking = #{raceResult.ranking},
            lastRapTime = #{raceResult.lastRapTime}
    </insert>

    <sql id="raceJoin">
        SELECT DISTINCT
            ${column}
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        WHERE
            raceHorse.horseId = horse.id
        AND
            race.raceCondition = #{raceCondition.value}
        AND
            race.raceDate &gt; now() - INTERVAL 24 MONTH
    </sql>

    <sql id="fetchHorseResultSub">
        SELECT
            ${column}
        FROM
            race as subRace
        JOIN
            raceResult as subRaceResult
        ON
            subRace.id = subRaceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = subRaceResult.raceId
        AND
            raceHorse.frameNumber = subRaceResult.frameNumber
        WHERE
            subRace.id = race.id
    </sql>

    <select id="fetchBestRaceTimes" resultMap="BestTimeResultMap">
        SELECT
            horse.id as horseId,
            horse.name as horseName,
            horse.gender as horseGender,
            raceHorse.old as old,
            raceHorse.weight as weight,
            raceHorse.frameNumber as frameNumber,
            race.stadium as raceStadium,
            jockey.name as jockeyName,
            (
                <choose>
                    <when test='summaryType == @com.example.demo.valueobject.SummaryType@AVG'>
                        <include refid="raceJoin">
                            <property name="column" value="avg(fullTime)"/>
                        </include>
                    </when>
                    <otherwise>
                        <include refid="raceJoin">
                            <property name="column" value="min(fullTime)"/>
                        </include>
                    </otherwise>
                </choose>
                AND
                    race.raceLength = #{raceLength}
                <if test="stadium != null">
                AND
                    race.stadium = #{stadium}
                </if>
                <if test="stadium == null">
                AND
                    race.stadium = raceStadium
                </if>
            ) as summaryFullTime,
            (
                <include refid="raceJoin">
                    <property name="column" value="count(fullTime)"/>
                </include>
                AND
                    race.raceLength = #{raceLength}
                <if test="stadium != null">
                AND
                    race.stadium = #{stadium}
                </if>
                <if test="stadium == null">
                AND
                    race.stadium = raceStadium
                </if>
            ) as count,
            (
                <choose>
                    <when test='summaryType == @com.example.demo.valueobject.SummaryType@AVG'>
                        <include refid="raceJoin">
                            <property name="column" value="avg(lastRapTime)"/>
                        </include>
                    </when>
                    <otherwise>
                        <include refid="raceJoin">
                            <property name="column" value="min(lastRapTime)"/>
                        </include>
                    </otherwise>
                </choose>
                AND
                    race.raceLength = #{raceLength}
                <if test="stadium != null">
                AND
                    race.stadium = #{stadium}
                </if>
                <if test="stadium == null">
                AND
                    race.stadium = raceStadium
                </if>
            ) as summaryLastRapTime
        FROM
            horse
        JOIN
            raceHorse
        ON
            raceHorse.horseId = horse.id
        JOIN
            jockey
        ON
            raceHorse.jockeyId = jockey.id
        JOIN
            race
        ON
            raceHorse.raceId = race.id
        WHERE
            horse.id
        IN
            (
                select horse.id from race join raceHorse on race.id = raceHorse.raceId join horse on raceHorse.horseId = horse.id WHERE race.id = #{raceId}
            )
        AND
            raceHorse.raceId = #{raceId}
        ORDER BY
            raceHorse.frameNumber
    </select>

    <select id="fetchStadiumSummaryTimes" resultType="com.example.demo.entity.StadiumTime">
        SELECT DISTINCT
            <if test="time == 'fullTime'">
                avg(fullTime) as time,
            </if>
            <if test="time == 'lastRapTime'">
                avg(lastRapTime) as time,
            </if>
            count(fullTime) as count,
            race.stadium
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        WHERE
            race.raceLength = #{raceLength}
        AND
            raceResult.ranking = 1
        <if test="grade != null">
        AND
            race.grade = #{grade.value}
        </if>
        GROUP BY
            race.stadium
    </select>

    <select id="fetchRaceResultSummary" resultType="com.example.demo.entity.RaceResultSummary">
        SELECT
            avg(fullTIme) as meanFullTime,
            avg(lastRapTime) as meanLastRapTime,
            stddev_pop(fullTime) as stdevpFullTime,
            stddev_pop(lastRapTime) as stdevpLastRapTime
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        WHERE
            race.raceLength = #{raceLength}
        AND
            raceResult.ranking = 1
        <if test="stadium != null">
        AND
            race.stadium = #{stadium}
        </if>
        <if test="stadium == null">
            AND
            race.stadium = (
                SELECT
                    race.stadium
                FROM
                    race
                WHERE
                    race.id = #{raceId}
            )
        </if>
        AND
            race.raceCondition = #{raceCondition.value}
        <if test="grade != null">
        AND
            race.grade = #{grade.value}
        </if>
    </select>

    <select id="fetchHorseResult" resultMap="HorseResultMap">
        SELECT
            raceResult.*,
            race.*,
            (
                <include refid="fetchHorseResultSub">
                    <property name="column" value="avg(fullTIme) as meanFullTime"/>
                </include>
            ) as meanFullTime,
            (
                <include refid="fetchHorseResultSub">
                    <property name="column" value="avg(lastRapTime) as meanLastRapTime"/>
                </include>
            ) as meanLastRapTime,
            (
                <include refid="fetchHorseResultSub">
                    <property name="column" value="stddev_pop(fullTime) as stdevpFullTime"/>
                </include>
            ) as stdevpFullTime,
            (
                <include refid="fetchHorseResultSub">
                    <property name="column" value="stddev_pop(lastRapTime) as stdevpLastRapTime"/>
                </include>
            ) as stdevpLastRapTime
        FROM
            race
        JOIN
            raceResult
        ON
            race.id = raceResult.raceId
        JOIN
            raceHorse
        ON
            raceHorse.raceId = raceResult.raceId
        AND
            raceHorse.frameNumber = raceResult.frameNumber
        JOIN
            horse
        ON
            horse.id = raceHorse.horseId
        WHERE
            horse.id = #{horseId}
    </select>
</mapper>
